<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Cartographie</title>
    <link rel="stylesheet" href="assets/commons/js/leaflet-0.7/leaflet.css">
    <!-- <link rel="stylesheet" href="assets/js/leaflet-1.0/leaflet.css"> -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/leaflet-routing-machine.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        .sticky {
            position: fixed;
            top: 30px;
        }
        .definition-course {
            background-color: rgba(255,255,255,0.8);
            border: 1px solid #CCC;
            display: flex;
            left: 100px;
            padding: 0.5rem;
            z-index: 100;
        }
        .bano-suggestions {
            position: absolute;
            list-style: outside none none;
            background-color: white;
            padding: 1rem;
            z-index: 200;
        }
        .location-suggestion:hover {
            cursor: pointer;
            background-color: #0066FF;
            color: white;
        }
    </style>
</head>
<body id="display">
    <header class="entete">
        <!--h1>Cartographie des chauffeurs</h1-->
        <p class="session session-info">
            <span id="derniere-update">-</span>
            <span id="whois" contenteditable="true">me</span>
            <span id="presents"></span>
        </p>
    </header>
    <!--form class="user-form" action="index.html" method="post">
        <input type="text" name="id-getter" id="id-getter" value="me" placeholder="@id de la personne à positionner" size="30" />
    </form>
    <button id="gps">Voir les positions</button-->
    <main class="contenu">
        <div id="leafletmap"></div>
        <form id="form-request" class="sticky definition-course">
            <fieldset class="request-group">
                <label for="vehicule" />Berline</label>
                <input type="radio" name="vehicleType" id="vehicule-berline" value="berline" />
                <label for="vehicule" />Luxe</label>
                <input type="radio" name="vehicleType" id="vehicule-luxe" value="luxe" />
                <label for="vehicule" />Van</label>
                <input type="radio" name="vehicleType" id="vehicule-van" value="van" />
            </fieldset>
            <fieldset class="request-group">
                <label for="adresse-depart">Adresse de départ : </label>
                <input type="text" id="adresse-depart" class="suggestive" size="40" list="suggestions-adresses-depart" />
                <ul class="bano-suggestions" id="suggestions-adresses-depart"></ul>
                <button type="button" id="defaut-depart">Partir d'où je suis</button>
            </fieldset>
            <fieldset class="request-group">
                <label for="adresse-arrivee">Adresse d'arrivée : </label>
                <input type="text" id="adresse-arrivee" class="suggestive" size="40" list="suggestions-adresses-arrivee" />
                <ul class="bano-suggestions" id="suggestions-adresses-arrivee"></ul>
            </fieldset>
            <button type="submit" name="reserver" id="submit-reservation">Réserver</button>
            <span id="distance-estimee"></span>
        </form>
        <aside id="menu-principal" class="mobile">
            <div class="coulisse">
                <button class="actionneur">Options</button>
            </div>
            <ul class="options-menu">
                <li class="option"><a href="rideRequest.html">Réservation immediate</a></li>
                <li class="option">Réservation différée</li>
                <li class="option">Mes favoris</li>
                <li class="option">Mes paramètres</li>
            </ul>
        </aside>
    </main>
    <footer class="annexes">
    </footer>

    <!-- Scripts communs -->
    <!-- <script src="require.js"></script> -->
    <script src="assets/commons/js/jquery-2.2.3.min.js"></script>
    <script src="assets/commons/js/detector.js"></script>
    <script src="assets/commons/js/leaflet-1.0/leaflet.js"></script>
    <script src="assets/js/leaflet-routing-machine.min.js"></script>
    <script src="assets/commons/js/position.js"></script>
    <script src="assets/commons/js/promise.min.js"></script>
    <script src="assets/commons/js/jsonld.js"></script>
    <script src="assets/commons/js/dialogs.js"></script>
    <!-- Scripts passagers -->
    <script src="assets/js/adresses.js"></script>
    <script src="assets/js/passenger.js"></script>
    <script src="assets/js/conf.js"></script>
    <script src="assets/js/boot.js"></script>
    <script>

    // extension à jQuery (empruntée à rdfviewer):
    $.extend({
        getUrlVars: function(){
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for(var i = 0; i < hashes.length; i++)
            {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        },
        getUrlVar: function(name){
            return $.getUrlVars()[name];
        }
    });

    // récupérer @id et name depuis l'URL HTTP
	var name = $.getUrlVar("name"),
        qid = $.getUrlVar("@id"),
        driverIdentity = localStorage.getItem('driverIdentity'); // Inspecter l'identité sauvegardée

    if (typeof qid === 'undefined') { qid = driverIdentity };
    if (typeof qid === 'undefined') {
        id = $("#whois").text();
        qid = id;
    } else {
        $("#whois").text(qid)
    };
    // id = (qid ? qid : (driverIdentity ? driverIdentity : $("#whois").text()));
    // Rendre l'URI de l'identifiant absolu
    console.log(qid);
    if (/^\[a-z]{3,5}:/.test(qid)) {
        id = qid;
    } else if (qid.indexOf('@') !== -1) {
        id = 'mailto:'+qid;
    } else {
        id = 'urn:'+qid
    }

    // Sauvegarder l'identité
    localStorage.setItem('passengerIdentity', id);

    console.log(status);

    // Le passager est inactif
    window.passensgerStatus = status.IDLE;
    sessionStorage.setItem('passengerStatus', status.IDLE);

    $(window).ready(function () {
        // console.log("isMobile : " + deviceDetector.isMobile);
        var inputHasFocus;
        Boot.getIdentity();

        $('.suggestive')
        .on('keyup', function() {
            Adresses
            .suggest($(this).val(), $(this).attr('list'))
            .then(Adresses.suggestionsBuild);
        })
        .on('focus', function() {
            window.inputHasFocus = $(this);
            console.log($(this).prop('id'));
        });
        // $(".suggestive").on('blur', function() {
        //     inputHasFocus = null;
        // });

        if ('touchend' in navigator) {eventAlternative = 'touchend'} else {eventAlternative = 'click'};
        $('.actionneur').on(eventAlternative, function () {
            // petit menu déroulant:
            $mobile = $(this).closest('.mobile');
            if ($mobile.css('left').slice(0,1) == "-") {
                $mobile.animate({left: "+=200"})
            } else {
                $mobile.animate({left: "-=200"})
            }
        })
        $('#submit-reservation').on(eventAlternative, function (event) {
            event.preventDefault();
            Passenger.rideBook().then(Passenger.rideAnswer);
        })
        $('#defaut-depart').on(eventAlternative, function (event) {
            event.preventDefault();
            Pins.gpsPicker(Boot.whois.pseudo, Adresses.fromThere);
        })
        $('.bano-suggestions').on('click', '.location-suggestion', function() {
            Pins.trafficMap.setView([$(this).data('lat'),$(this).data('lng')], 16);
            let $menu = $(this).closest('.bano-suggestions');
            let $input = $menu.prev('.suggestive');
            $input.val($(this).text());
            $input.data('lat', $(this).data('lat'));
            $input.data('lng', $(this).data('lng'));
            $menu.empty();
            Adresses.markEtape($(this).data('lat'), $(this).data('lng'), $input.prop('id').slice(8,9))

        })

        // Affichage inital de la carte
        Pins.gpsPicker()
            .then(Pins.positionMake, Pins.positionFail)
            .then(Passenger.passengerMap, Pins.warning)
            // TODO:Afficher la carte même en cas d'err
            .then(function(){}, function(){});

        Pins.trafficMap.on('click', function (event) {
            if (window.inputHasFocus === undefined) {
                window.inputHasFocus = $("#adresse-depart");
            }
            console.log(window.inputHasFocus);
            console.log(event.latlng);
            Adresses.address(event.latlng);
        })
    })
    </script>


</body></html>
